on:
  push:
    branches:
    - main
name: ğŸš€ Validate and deploy website on push
jobs:
  web-flow:
    name: Website Build, Validate, and Deploy
    runs-on: ubuntu-latest
    steps:
      - name: ğŸšš Get latest code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'  
      - name: Install Minifier Tools
        run: npm install terser html-minifier csso-cli
      - name: Install Validation Tools
        run: npm install htmlhint eslint stylelint stylelint-config-standard
      - name: âœ… Validating HTML
        run: |
          npx htmlhint index.html
      - name: âœ… Validating JavaScript
        run: |
          npx eslint index.js
      - name: âœ… Validating CSS
        run: |
          npx stylelint index.css
      - name: ğŸ“ Minifying HTML
        run: |
          npx html-minifier --collapse-whitespace --remove-comments --minify-css true --minify-js true -o index.html index.html
      - name: ğŸ“ Minifying JavaScript
        run: |
          npx terser index.js -o index.js --compress --mangle --comments "/eslint/"
      - name: ğŸ“ Minifying CSS
        run: |
          npx csso-cli index.css --output index.css
      - name: âœ… Validate minified HTML
        run: |
          npx htmlhint index.html
      - name: âœ… Validate minified JavaScript
        run: |
          npx eslint index.js
      - name: âœ… Validate minified CSS
        run: |
          npx stylelint index.css
      - name: Download latest release of WebReleaseNotes
        uses: robinraju/release-downloader@v1.12
        with:
          repository: "zRenard/WebReleaseNotes"
          latest: true
          fileName: "*"  # Download all files
          out-file-path: "./"  # Save to the root of the workspace
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      - name: Install Python dependencies
        run: pip install GitPython
      - name: ğŸ“¦ Build release notes JSON
        run: python release_notes.py --num_commits 15 --output release_notes.json 
      - name: ï¿½ Prepare deployment files
        run: |
          mkdir -p deploy
          cp index.html deploy/
          cp release_notes.html deploy/
          cp release_notes.json deploy/
          cp release_notes.js deploy/
          cp release_notes.css deploy/
          cp index.js deploy/
          cp index.css deploy/
          cp nanardi.png deploy/
          cp goodenough.jpg deploy/
          cp fav.png deploy/
          cp -r media deploy/
      - name: ğŸ“‚ Sync files
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ftp.cluster010.hosting.ovh.net
          username: ${{ secrets.ftp_username }}
          password: ${{ secrets.ftp_password }}
          server-dir: /www/nanardi/
          local-dir: ./deploy/
          state-name: .ftp-deploy-sync-state.json
          dry-run: false
